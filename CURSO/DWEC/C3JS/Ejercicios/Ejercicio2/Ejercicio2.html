<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="../../c3-0.7.20/docs/js/d3-5.8.2.min.js"></script>
    <script src="../../c3-0.7.20/c3.min.js"></script>

    <link rel="stylesheet" href="../../c3-0.7.20/c3.css">

    <style type="text/css">
        #salGrafico {
            width: 100%;
            height: 680px;
            border: 1px solid;
        }
    </style>

    <script type="text/javascript">
        window.onload = () => {
            document.querySelector("#archivoXML").addEventListener("change", Leer_Fichero);
        }

        let xml = null;

        //Función para leer el fichero xml
        function Leer_Fichero(evento) {
            let e = evento || window.event; //Guardar en una variabel el evento accionado
            let fichero = e.target.files[0]; //Guardar el fichero en una variable

            function Convertir_a_XML(texto) { //Función para convertir a xml
                if (window.ActiveXObject) {
                    xml = new ActiveXObject("Microsoft.XMLDOM");
                    xml.loadXML(texto);
                } else {
                    xml = new DOMParser().parseFromString(texto, "text/xml");
                    return xml;
                }
            }

            let reader = new FileReader(); //Instanciar un reader

            reader.onload = function (e) { //Cuando se cargue el fichero, convertir a xml y devolver resultado
                let miXml = Convertir_a_XML(reader.result);
                xml = miXml;
                //console.log("miXml: ", miXml);
                tratarXML(miXml);
            }
            reader.readAsText(fichero); //Leer el fichero como texto
        }

        //Función para tratar el xml y crear los puntos
        function tratarXML(xml) {
            //Sacar las filas del xml
            let rows = xml.getElementsByTagName("row");

            //Sacar la primera fila para sacar el número de atributos y cargar la lista con los mismos
            let row = xml.getElementsByTagName("row")[0];
            cargarSelect(row);

            /*
            for (let i = 0; i < rows.length; i++) {
                console.log(rows[i].getElementsByTagName("trimestre")[0].tagName);
                
            }
            */

            let div = "#salGrafico";
        }

        // Función para cargar la lista de atributos del XML
        const cargarSelect = (row) => {
            /*
            //Guardar en una constante los hijos de la fila
            const hijos = Array.from(row.children);

            let select = document.querySelector("#listaAtributos");

            //Asginar el size del select con el número de hijos de la fila
            select.size = hijos.length;

            //Limpiar opciones existentes
            select.innerHTML = "";

            //Por cada iteración, crear un option y añadir el el nombre del elemento hijo
            hijos.forEach((hijo) => {
                let option = document.createElement("option");
                option.value = hijo.tagName;
                option.innerHTML = hijo.tagName;

                select.appendChild(option);
            });
            */

            //Guardar en una constante los hijos de la fila
            const children = row.children; //Trae un HTMLCollection, que no necesariamente es un array, aunque puede usarse como tal
            const numOptions = children.length;

            let select = document.querySelector("#listaAtributos");

            //Asginar el size del select con el número de hijos de la fila
            select.size = numOptions;

            //Limpiar opciones existentes (si es necesario)
            select.innerHTML = "";

            //Por cada iteración, crear un option y añadir el el nombre del elemento hijo
            for (let i = 0; i < numOptions; i++) {
                let child = children[i];
                let option = document.createElement("option");
                option.value = child.tagName;
                option.innerHTML = child.tagName;

                select.appendChild(option);
            }

            /*
            for (let i = 0; i < numOptions; i++) {
                console.log(children[i].tagName);
            }
            */

        };


        const pintarGrafico = (div, datosAltitud) => {
            //Crear un chart 
            let chart = c3.generate({
                bindto: div,
                data: {
                    columns: [
                        datosAltitud
                    ],
                    types: {
                        Altitud: "area"
                    }
                }
            });

            alert("Gráfico pintado con éxito");

            crearJSON(XML);
        }
    </script>
</head>

<body>
    <h1 style="text-align: center; color: #800000;">Datos Estadísticos de la EPA</h1>
    <hr size="1px" color="#800000">
    <p>
        <input type="file" name="archivoXML" id="archivoXML">

        <button type="button" id="btDescargarJSON">Descargar JSON</button>
    </p>
    <p>
        <select name="listaAtributos" id="listaAtributos">

        </select>
    </p>

    <p>
    <div id="salGrafico">

    </div>
    </p>
</body>

</html>